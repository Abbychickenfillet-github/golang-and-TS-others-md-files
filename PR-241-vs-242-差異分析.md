# PR #241 vs PR #242 差異分析

## 總覽

| PR | 檔案數 | 新增 | 刪除 | 狀態 |
|----|--------|------|------|------|
| #241 | 40 個 | +650 | -1325 | ❌ 已關閉 |
| #242 | 3 個 | +32 | -18 | ✅ 開啟中 |

**為什麼差這麼多？**
- PR #241 基於 `feature/role-permission-improvements`（較舊的分支）
- PR #242 基於 `Go_production`（最新），只 cherry-pick 需要的修改

---

## PR #241 檔案詳細說明

### 1. 設定檔類（會被刪除/修改）

| 檔案 | +/- | 說明 |
|------|-----|------|
| `.air.toml` | +3/-3 | Air 熱更新設定，Go_production 有更新的設定 |
| `.env.development` | +1/-9 | 開發環境變數，Go_production 有更多設定（如 ECPay） |
| `.env.production` | +17/-116 | 生產環境變數，**Go_production 有完整的生產設定** |

**問題**：feature branch 的 env 設定較舊，會覆蓋 Go_production 的完整設定。

---

### 2. PLAN 文件（位置移動）

| 檔案 | 說明 |
|------|------|
| `PLAN_APPLY_COMPANY.md` | 從 `docs/` 移到根目錄（或反向） |
| `PLAN_APPROVE_REFUND.md` | 同上 |
| `PLAN_COMPANY_STATISTICS.md` | 同上 |
| `PLAN_GENERAL_CONTRACTORS.md` | 同上 |
| `PLAN_GET_EVENT_STATISTICS.md` | 同上 |
| `PLAN_GET_EVENT_VENDORS.md` | 同上 |
| `PLAN_ITEMS_CHECK_IN_STATUS.md` | 同上 |
| `PLAN_MEMBER_COMPANY.md` | 同上 |
| `PLAN_MY_TICKETS.md` | 同上 |
| `PLAN_ORDER_EXPORT.md` | 同上 |
| `PLAN_ORDER_NOTIFICATION.md` | 同上 |
| `PLAN_ORDER_SUMMARY.md` | 同上 |
| `VERIFICATION_*.md` | 同上 |

**說明**：這些是開發計畫文件，Go_production 把它們整理到 `docs/` 資料夾。

---

### 3. 測試檔案

| 檔案 | +/- | 說明 |
|------|-----|------|
| `db_health_test.go` | +1/-1 | `setupCORS(router)` → `setupCORS(router, cfg)` |
| `main_test.go` | +5/-12 | 測試更新，配合 main.go 的變更 |
| `order_handler_test.go` | -27 | **刪除** check-in 相關測試 |
| `order_notification_handler_test.go` | -24 | **刪除** 通知相關測試 |
| `order_summary_handler_test.go` | -9 | **刪除** 訂單摘要測試 |
| `order_service_test.go` | -8 | **刪除** 服務層測試 |

**問題**：feature branch 沒有這些測試，所以 PR 顯示要「刪除」。

---

### 4. 主程式 main.go（核心差異）

| 變更 | 說明 |
|------|------|
| `-setupCORS(router, cfg)` | Go_production 用 cfg 參數 |
| `+setupCORS(router)` | feature branch 用舊版（無 cfg） |
| `-router.RemoveExtraSlash = true` | Go_production 有這個設定 |
| `-import "path"` | Go_production 用 path 處理路徑 |
| `+33/-62` | 很多路由設定差異 |

**核心差異**：
```go
// Go_production（新）
func setupCORS(router *gin.Engine, cfg *config.Config) {
    origins := computeAllOrigins(cfg)  // 動態計算 CORS origins
    // 包含 ECPay 域名處理
}

// feature branch（舊）
func setupCORS(router *gin.Engine) {
    corsOrigins := getEnv("CORS_ORIGINS", "...")  // 從環境變數讀取
}
```

---

### 5. DTO（資料傳輸物件）

| 檔案 | +/- | 說明 |
|------|-----|------|
| `check_in.go` | -55 | **完全刪除** check-in DTO |

**內容**：
```go
// 這個檔案定義了自助報到的資料結構
type CheckInStatsResponse struct {
    EventID          string
    TotalTickets     int
    CheckedInTickets int
    // ...
}

type CheckInListResponse struct {
    // 報到清單
}
```

**問題**：feature branch 沒有這個檔案，所以 PR 顯示要刪除整個 check-in 功能。

---

### 6. Handler（HTTP 處理器）

| 檔案 | +/- | 說明 |
|------|-----|------|
| `file_handler.go` | +130 | **新增** 檔案上傳處理（feature branch 有） |
| `google_oauth_handler.go` | +7/-19 | OAuth 處理差異 |
| `image_handler.go` | +8/-6 | 圖片上傳邏輯差異 |
| `order_handler.go` | -247 | **刪除** 247 行 check-in 相關程式碼 |
| `product_handler.go` | +88/-3 | **你的修改**：TryBothAuth 權限 |
| `product_type_handler.go` | +89/-3 | **你的修改**：TryBothAuth 權限 |

**order_handler.go 被刪除的內容**：
```go
// SelfCheckIn 自助報到
func (h *OrderHandler) SelfCheckIn(c *gin.Context) { ... }

// GetCheckInStats 取得活動報到統計
func (h *OrderHandler) GetCheckInStats(c *gin.Context) { ... }

// GetCheckInList 取得活動報到清單
func (h *OrderHandler) GetCheckInList(c *gin.Context) { ... }
```

---

### 7. Repository（資料存取層）

| 檔案 | +/- | 說明 |
|------|-----|------|
| `order_repository.go` | +1/-31 | **刪除** 報到相關的資料庫查詢 |

**被刪除的方法**：
```go
// GetByPhoneAndEventID 根據電話和活動 ID 查詢訂單
func (r *orderRepository) GetByPhoneAndEventID(phone, eventID string) ([]models.Order, error)

// GetByOrderNumberPrefix 根據訂單編號前綴查詢
func (r *orderRepository) GetByOrderNumberPrefix(prefix, eventID string) ([]models.Order, error)
```

---

### 8. Service（商業邏輯層）

| 檔案 | +/- | 說明 |
|------|-----|------|
| `file_service.go` | +186 | **新增** 檔案服務（feature branch 有） |
| `image_service.go` | +29/-14 | 圖片服務邏輯差異 |
| `order_service.go` | -662 | **刪除** 662 行！check-in 核心邏輯 |

**order_service.go 被刪除的內容**：
```go
// SelfCheckIn 自助報到
func (s *orderService) SelfCheckIn(ctx context.Context, eventID, phone, code, ticketID string) (map[string]interface{}, error)

// GetCheckInStats 取得活動報到統計
func (s *orderService) GetCheckInStats(ctx context.Context, eventID string) (*dto.CheckInStatsResponse, error)

// GetCheckInList 取得活動報到清單
func (s *orderService) GetCheckInList(ctx context.Context, eventID string, ...) (*dto.CheckInListResponse, error)

// normalizePhoneVariants 電話號碼格式化（支援 +886、0910 等格式）
func normalizePhoneVariants(phone string) []string

// performTicketCheckIn 執行票券報到
func (s *orderService) performTicketCheckIn(item *models.OrderItem, order *models.Order) (map[string]interface{}, error)
```

---

### 9. Storage（儲存層）

| 檔案 | +/- | 說明 |
|------|-----|------|
| `s3.go` | +45/-2 | S3 儲存邏輯，Go_production 有 PDF 支援 |
| `s3_test.go` | +4/-5 | S3 測試更新 |

---

## PR #242 檔案說明（只有 3 個）

| 檔案 | +/- | 說明 |
|------|-----|------|
| `main.go` | +17/-13 | Product API 路由改用 TryBothAuth |
| `refund_repository.go` | +10/-0 | 新增 DeletePendingByOrderID 方法（修 bug） |
| `order_service.go` | +5/-5 | 修復型別錯誤（RefundRecordRepository → RefundRepository） |

---

## 結論

### PR #241 的問題
- 會**刪除** Ryan 加的 check-in 功能（662+ 行）
- 會**降級** setupCORS 設定
- 會**刪除**測試檔案
- 會**覆蓋** .env 設定

### PR #242 為什麼正確
- 基於 Go_production（保留所有現有功能）
- 只加入需要的 Product API 修改
- 順便修復 Go_production 原有的 build 錯誤

---

## 附註：誰寫了什麼

| 功能 | 作者 |
|------|------|
| setupCORS(router, cfg) | Ryan (BrianNguyen291) |
| SelfCheckIn 自助報到 | Ryan (BrianNguyen291) |
| GetCheckInStats 報到統計 | Ryan (BrianNguyen291) |
| ECPay CORS 處理 | Ryan (BrianNguyen291) |
| Product API TryBothAuth | Abby |
| file_handler.go 檔案上傳 | Abby |
