# Redis 介紹

## Redis 是什麼？

**Redis = Remote Dictionary Server（遠端字典伺服器）**

簡單說：Redis 是一個把資料存在**記憶體（RAM）**的資料庫，用來當**快取（Cache）**。

---

## 為什麼記憶體比硬碟快？

```
┌─────────────────────────────────────────────────────────────┐
│                    電腦儲存速度比較                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  CPU 暫存器  ████████████████████████████████  最快（奈秒） │
│  記憶體 RAM  ████████████████████             快（奈秒）    │
│  SSD 固態硬碟 ████████                        中（微秒）    │
│  HDD 傳統硬碟 ██                              慢（毫秒）    │
│                                                             │
│  記憶體比硬碟快 10 萬倍以上！                                │
└─────────────────────────────────────────────────────────────┘
```

| 儲存位置 | 速度 | 比喻 |
|----------|------|------|
| **記憶體 (RAM)** | ~100 奈秒 | 伸手拿桌上的便利貼 |
| **SSD 硬碟** | ~100 微秒 | 走到隔壁房間拿文件 |
| **HDD 硬碟** | ~10 毫秒 | 搭電梯去地下室倉庫找檔案 |

---

## Redis 與資料庫的關係

### 沒有 Redis 的情況

```
用戶請求「查詢商品」
        │
        ▼
┌───────────────┐
│   後端 API    │
└───────┬───────┘
        │
        ▼ 每次都要查資料庫（慢）
┌───────────────┐
│   MySQL/PG    │  ← 資料存在硬碟
│   關聯式資料庫 │     讀取需要 10~100 毫秒
└───────────────┘
```

**問題：** 每次請求都要去硬碟讀資料，很慢！

---

### 有 Redis 的情況

```
用戶請求「查詢商品」
        │
        ▼
┌───────────────┐
│   後端 API    │
└───────┬───────┘
        │
        ▼ 先問 Redis 有沒有？
┌───────────────┐
│    Redis      │  ← 資料存在記憶體
│   （快取）     │     讀取只要 0.1~1 毫秒
└───────┬───────┘
        │
   有資料？─────────► 直接回傳（超快！）
        │ 沒有
        ▼
┌───────────────┐
│   MySQL/PG    │  ← 去資料庫查
└───────┬───────┘
        │
        ▼
   存一份到 Redis（下次就不用再查資料庫了）
```

---

## 生活化比喻

```
┌─────────────────────────────────────────────────────────────┐
│  情境：你要查某個客戶的電話                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  【沒有快取】                                                │
│  每次都要去檔案室翻厚重的客戶資料夾 → 很慢（10分鐘）         │
│                                                             │
│  【有快取 = Redis】                                          │
│  第一次：去檔案室找，找到後寫在桌上便利貼                    │
│  之後：直接看便利貼 → 超快（1秒）                            │
│                                                             │
│  ┌──────────┐          ┌──────────────┐                     │
│  │ 便利貼   │          │ 檔案室       │                     │
│  │ (Redis)  │          │ (MySQL)      │                     │
│  │ 記憶體   │          │ 硬碟         │                     │
│  │ 快但小   │          │ 慢但大       │                     │
│  └──────────┘          └──────────────┘                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 快取流程（Cache Pattern）

### Cache-Aside（旁路快取）- 最常見

```python
def get_product(product_id):
    # 1. 先查 Redis
    cached = redis.get(f"product:{product_id}")

    if cached:
        # 2a. 有快取 → 直接回傳（Cache Hit）
        return json.loads(cached)

    # 2b. 沒快取 → 查資料庫（Cache Miss）
    product = db.query(Product).get(product_id)

    # 3. 存到 Redis（下次就有了）
    redis.set(f"product:{product_id}", json.dumps(product), ex=3600)  # 1小時過期

    return product
```

```
┌─────────────────────────────────────────────────────────┐
│                    快取命中 vs 未命中                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Cache Hit（命中）：Redis 有資料 → 0.1ms 回傳           │
│  Cache Miss（未命中）：Redis 沒資料 → 去 DB 查 → 50ms   │
│                                                         │
│  目標：讓 Cache Hit 比例越高越好（90%+）                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Redis 不是取代資料庫！

```
┌─────────────────────────────────────────────────────────────┐
│                   Redis vs 關聯式資料庫                      │
├───────────────┬─────────────────┬───────────────────────────┤
│               │     Redis       │    MySQL/PostgreSQL       │
├───────────────┼─────────────────┼───────────────────────────┤
│ 儲存位置      │ 記憶體（RAM）   │ 硬碟（SSD/HDD）          │
│ 速度          │ 超快（<1ms）    │ 較慢（10-100ms）         │
│ 容量          │ 小（幾十GB）    │ 大（幾TB）               │
│ 資料持久性    │ 重啟可能消失    │ 永久保存                 │
│ 資料結構      │ Key-Value       │ 表格、關聯              │
│ 適合          │ 快取、Session   │ 主要資料儲存            │
└───────────────┴─────────────────┴───────────────────────────┘
```

**重點：Redis 是「輔助」資料庫，不是「取代」資料庫！**

---

## 我們專案中的 Redis

### 架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                    專案架構                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐ │
│  │  Frontend   │      │  Backend    │      │   MySQL     │ │
│  │  (React)    │ ───► │  (FastAPI)  │ ───► │  (資料庫)   │ │
│  └─────────────┘      └──────┬──────┘      └─────────────┘ │
│                              │                              │
│                              ▼                              │
│                       ┌─────────────┐                       │
│                       │   Redis     │  ← Docker 容器        │
│                       │  (快取)     │     port 6380         │
│                       └─────────────┘                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Redis 怎麼安裝？

```
┌─────────────────────────────────────────────────────────────┐
│  ❌ 不是 npm install！                                       │
│                                                             │
│  Redis 有兩個部分：                                          │
│                                                             │
│  1. Redis 伺服器 → Docker 容器                              │
│     docker-compose.yml 中：                                 │
│     image: redis:7-alpine                                   │
│                                                             │
│  2. Python 套件 → pip/uv 安裝（用來連接 Redis）             │
│     import redis  ← backend/app/core/redis.py              │
│                                                             │
│  如果是 Node.js 專案才用 npm install redis                  │
└─────────────────────────────────────────────────────────────┘
```

### 專案中的用途（backend/app/core/redis.py）

| 功能 | 說明 | Redis Key 範例 |
|------|------|----------------|
| **驗證碼管理** | Email 驗證碼存 Redis（5分鐘過期） | `verification_code:user@email.com` |
| **API 限流** | 防止惡意請求（每分鐘最多 N 次） | `rate_limit:ip:192.168.1.1` |
| **Refresh Token** | 登入 Token 存 Redis | `refresh_token:{hash}` |
| **冷卻期控制** | 重發驗證碼要等 1 分鐘 | `resend_cooldown:user@email.com` |
| **WebSocket 通知** | 即時通知用 | `websocket_connections` |

### 啟動 Redis

```bash
# 啟動整個 Docker 環境（包含 Redis）
docker compose up -d

# 檢查 Redis 是否運行
docker compose ps redis
```

---

## 常見 Redis 使用場景

### 1. 快取（Cache）
```python
# 把熱門商品存到 Redis
redis.set("hot_products", json.dumps(products), ex=300)  # 5分鐘過期
```

### 2. Session 管理
```python
# 用戶登入狀態存 Redis（多台伺服器共用）
redis.set(f"session:{session_id}", user_data, ex=86400)  # 1天過期
```

### 3. 排行榜（Sorted Set）
```python
# 遊戲分數排行榜
redis.zadd("leaderboard", {"player1": 100, "player2": 85})
redis.zrevrange("leaderboard", 0, 9)  # 取前 10 名
```

### 4. 訊息佇列（Queue）
```python
# 生產者放任務
redis.lpush("task_queue", task_data)

# 消費者取任務
task = redis.brpop("task_queue")
```

### 5. 分散式鎖（Lock）
```python
# 防止重複扣款
redis.set("lock:order:123", "locked", ex=30, nx=True)
```

---

## 資料會不會消失？

Redis 預設資料在記憶體，但有兩種持久化方式：

| 方式 | 說明 | 優缺點 |
|------|------|--------|
| **RDB** | 定期快照存到硬碟 | 快，但可能丟失最近資料 |
| **AOF** | 每次寫入都記錄 | 安全，但較慢 |

```
即使 Redis 資料消失也沒關係！
因為正本還在 MySQL/PostgreSQL，Redis 只是「副本」快取
```

---

## 總結

```
┌─────────────────────────────────────────────────────────────┐
│                      Redis 重點整理                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. Redis 把資料存在記憶體 → 速度超快（<1ms）               │
│                                                             │
│  2. Redis 當「快取」用 → 減少資料庫查詢次數                 │
│                                                             │
│  3. 關係：Redis 是「便利貼」，MySQL 是「檔案室」            │
│          常用的抄到便利貼，不用每次都跑檔案室               │
│                                                             │
│  4. Redis 不取代資料庫！主資料還是存在 MySQL/PG             │
│                                                             │
│  5. sub-millisecond latency = 延遲小於 1 毫秒（超快）       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```
