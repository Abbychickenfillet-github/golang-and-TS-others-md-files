# Backend 架構層級與引用關係

## 問題紀錄

**問題**：為什麼 `app/crud/order_log.py` 引入了 `OrderLogAction` 但沒用到？

**原因**：CRUD 層只負責資料庫操作，不需要知道業務邏輯（如 Action 類型）。`OrderLogAction` 應該在 Service 層使用。

---

## 架構層級（由下到上）

```
┌─────────────────────────────────────────────────────────┐
│  API Routes (app/api/routes/)                           │
│  - 接收 HTTP 請求，回傳 HTTP 回應                        │
│  - 呼叫 Service 層處理業務邏輯                           │
└─────────────────────────────────────────────────────────┘
                          ↓ 呼叫
┌─────────────────────────────────────────────────────────┐
│  Service (app/services/)                                │
│  - 業務邏輯層                                            │
│  - 組合多個 CRUD 操作                                    │
│  - 使用 Enum（如 OrderLogAction）做業務判斷              │
└─────────────────────────────────────────────────────────┘
                          ↓ 呼叫
┌─────────────────────────────────────────────────────────┐
│  CRUD (app/crud/)                                       │
│  - 純資料庫操作（Create, Read, Update, Delete）          │
│  - 不含業務邏輯                                          │
│  - 只引入需要的 Model                                    │
└─────────────────────────────────────────────────────────┘
                          ↓ 引用
┌─────────────────────────────────────────────────────────┐
│  Model (app/models/)                                    │
│  - 資料表結構定義                                        │
│  - Enum 定義（如 OrderLogAction, OrderStatus）          │
│  - 欄位驗證規則                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 引用規則

| 層級 | 可以引用 | 不應引用 |
|------|----------|----------|
| **API Routes** | Service, Model | CRUD（應透過 Service） |
| **Service** | CRUD, Model, 其他 Service | API Routes |
| **CRUD** | Model | Service, API Routes |
| **Model** | 無（最底層） | 其他任何層 |

---

## 實際範例：order_log

### Model (`app/models/order_log.py`)
```python
class OrderLogAction(str, Enum):
    CANCEL = "CANCEL"
    REFUND_REVIEW = "REFUND_REVIEW"
    EDIT = "EDIT"

class OrderLog(SQLModel, table=True):
    order_id: str
    action: str  # 儲存 OrderLogAction.value
    ...
```

### CRUD (`app/crud/order_log.py`)
```python
from app.models.order_log import OrderLog  # ✅ 只引入 Model

class OrderLogCRUD:
    def get_by_action(self, session, order_id: str, action: str):
        # action 是 string，不需要知道 Enum
        ...
```

### Service (`app/services/order_log_service.py`)
```python
from app.models.order_log import OrderLog, OrderLogAction  # ✅ 引入 Enum

class OrderLogService:
    def log_cancel(self, session, order_id: str):
        log = OrderLog(
            order_id=order_id,
            action=OrderLogAction.CANCEL.value,  # 使用 Enum
        )
```

### API Route (`app/api/routes/orders.py`)
```python
from app.services.order_log_service import order_log_service  # ✅ 透過 Service

@router.post("/cancel")
def cancel_order():
    order_log_service.log_cancel(...)  # 不直接用 CRUD
```

---

## 為什麼這樣設計？

1. **單一職責**：每層只做一件事
2. **易於測試**：可以單獨測試每一層
3. **降低耦合**：修改業務邏輯不影響資料庫操作
4. **程式碼複用**：多個 Service 可共用同一個 CRUD
