# 工作日誌 2026-01-13

## 今日完成事項

### 1. V4 資料庫結構優化 - Order 表拆分

**需求：** 根據 `plans/綠界測試.md` 中的「資料庫結構優化建議 v4 完整拆分方案」，將 order 表從 31 欄精簡至 14 欄核心欄位。

**資料庫變更：**

直接連線到 Zeabur MySQL 資料庫執行以下操作：

```sql
-- 先移除外鍵約束
ALTER TABLE `order` DROP FOREIGN KEY `fk_order_edited_by`;

-- 刪除 17 個非核心欄位
ALTER TABLE `order`
  DROP COLUMN `edited_by_user_id`,
  DROP COLUMN `edited_at`,
  DROP COLUMN `edit_comment`,
  DROP COLUMN `invoice_number`,
  DROP COLUMN `invoice_status`,
  DROP COLUMN `invoice_issued_at`,
  DROP COLUMN `cancelled_at`,
  DROP COLUMN `cancelled_by`,
  DROP COLUMN `cancellation_reason`,
  DROP COLUMN `refunded_at`,
  DROP COLUMN `refund_amount`,
  DROP COLUMN `refund_reason`,
  DROP COLUMN `deleted_at`,
  DROP COLUMN `invoice_response_code`,
  DROP COLUMN `invoice_response_message`,
  DROP COLUMN `ecpay_request_log`,
  DROP COLUMN `ecpay_response_log`;
```

**Order 表結構 (修改後 14 欄)：**

| 欄位 | 說明 |
|------|------|
| `id` | 主鍵 UUID |
| `order_number` | 訂單編號 |
| `order_type` | 訂單類型 (b2c_ticket, b2b_booth 等) |
| `event_id` | 活動 ID |
| `buyer_id` | 買方 ID (member/company) |
| `buyer_company_id` | 買方公司 ID |
| `seller_company_id` | 賣方公司 ID |
| `total_amount` | 總金額 |
| `currency` | 幣別 |
| `status` | 訂單狀態 |
| `payment_status` | 付款狀態 |
| `check_in_status` | 報到狀態 |
| `created_at` | 建立時間 |
| `updated_at` | 更新時間 |

**已確認的關聯表：**

| 表名 | 欄位數 | 用途 |
|------|--------|------|
| `order_invoice` | 22 | 發票資訊 (發票號碼、統編、綠界回應等) |
| `order_log` | 7 | 訂單操作紀錄 (修改、取消、退款等) |

**Python 模型更新：**

| 檔案 | 修改內容 |
|------|---------|
| `backend/app/models/order.py` | 移除已刪除欄位、更新 TYPE_CHECKING imports |
| `backend/app/models/refund_record.py` | 修復 JSON import 遺漏 |
| `backend/app/models/user.py` | 移除 `edited_orders` relationship |
| `backend/app/models/__init__.py` | 新增 OrderInvoice, OrderLog exports |

**前端類型更新：**

| 檔案 | 修改內容 |
|------|---------|
| `frontend/src/client/models/order.ts` | 簡化 OrderPublic interface |
| `official_website/src/client/models.ts` | 簡化 OrderPublic, OrderUpdate |
| `official_website/lib/api/types.ts` | 簡化 Order interface |
| `official_website/src/lib/api/types.ts` | 簡化 Order interface |

**遇到的問題與解決：**

1. **Foreign Key 阻擋欄位刪除**
   - 錯誤：`Cannot drop column 'edited_by_user_id': needed in a foreign key constraint 'fk_order_edited_by'`
   - 解決：先 DROP FOREIGN KEY 再 DROP COLUMN

2. **Container 啟動失敗**
   - 錯誤：`NameError: name 'JSON' is not defined` (refund_record.py)
   - 解決：補上 `from sqlalchemy import Column, JSON, ...`

3. **User 模型關聯錯誤**
   - 錯誤：`Class Order does not have a mapped column named 'edited_by_user_id'`
   - 解決：從 User 模型移除 `edited_orders` relationship

---

### 2. 修復 Orders API 500 錯誤

**問題：** `/api/v1/orders/` 端點返回 500 錯誤

**錯誤訊息：**
```
AttributeError: deleted_at
File "/app/app/crud/order.py", line 124, in get_multi
    statement = statement.where(Order.deleted_at.is_(None))
```

**原因：** V4 重構後移除了 `deleted_at` 欄位，但 CRUD、Service、API Routes 仍在引用。

**修復內容：**

| 檔案 | 修改 |
|------|------|
| `crud/order.py` | 移除 `deleted_at` 篩選、移除 `invoice_status`/`has_invoice`/`include_deleted` 參數 |
| `services/order_service.py` | 移除 `list_orders`/`count_orders` 中的 `invoice_status`/`has_invoice`/`include_deleted` 參數 |
| `api/routes/orders.py` | 移除 API Query 參數、更新 service 呼叫 |

---

### 3. 重構 order_service 使用子表

**需求：** 將 `order_service.py` 中使用已移除欄位的方法重構到使用 `order_invoice` 和 `order_log` 子表。

**新建檔案：**

| 檔案 | 用途 |
|------|------|
| `crud/order_invoice.py` | 訂單發票 CRUD 操作 |
| `crud/order_log.py` | 訂單操作紀錄 CRUD 操作 |
| `services/order_invoice_service.py` | 發票服務 (create_invoice, issue_invoice, void_invoice) |
| `services/order_log_service.py` | 紀錄服務 (log_cancel, log_refund_review, log_edit) |

**修改的方法：**

| 方法 | 原本 | 重構後 |
|------|------|--------|
| `delete_order` | `order.deleted_at = now` | 改為設定 `status=CANCELLED` + 寫入 `order_log` |
| `cancel_order` | `order.cancelled_by`, `cancellation_reason` | 寫入 `order_log` (action=CANCEL) |
| `revoke_cancellation_request` | `order.cancellation_reason = None` | 寫入 `order_log` (action=EDIT) |
| `process_refund` | `order.refunded_at`, `refund_amount` | 寫入 `order_log` (action=REFUND_REVIEW) |
| `issue_invoice` | `order.invoice_number`, `invoice_status` | 使用 `order_invoice_service.issue_invoice()` |
| `void_invoice` | `order.invoice_status = "voided"` | 使用 `order_invoice_service.void_invoice()` |

**API routes 修改：**

| Endpoint | 修改 |
|----------|------|
| `POST /{order_id}/invoice` | 從 `order_invoice` 子表取得發票資訊 |
| `POST /{order_id}/invoice/void` | 從 `order_invoice` 子表取得發票資訊 |
| `GET /{order_id}/invoice` | 從 `order_invoice` 子表取得完整發票資訊（含載具、捐贈碼等）|

---

### 4. 修復前端 TypeScript Build 錯誤

**問題：** 前端檔案仍引用已移除的 Order 欄位導致 build 失敗

**錯誤訊息：**
```
src/routes/_layout/check-in.tsx: Property 'backend_check_in_at' does not exist on type 'OrderPublic'
src/routes/_layout/invoices.tsx: Property 'invoice_status' does not exist on type 'OrderPublic'
src/routes/_layout/orders.tsx: Property 'invoice_status' does not exist on type 'OrderPublic'
```

**修復內容：**

| 檔案 | 修改 |
|------|------|
| `check-in.tsx` | 移除 `backend_check_in_at`、`backend_check_in_by_user_id`、`frontend_check_in_at` 顯示區塊、移除未使用的 `userMap` |
| `invoices.tsx` | 暫時設定發票欄位為預設值（待整合） |
| `orders.tsx` | 暫時停用發票功能（待整合） |

---

### 5. 整合 order_invoice 子表至前端

**需求：** 將 `order_invoice` 子表的發票資訊整合到 `OrderPublic`，讓前端可以正常顯示發票資訊。

**後端修改：**

| 檔案 | 修改 |
|------|------|
| `models/order.py` | `OrderPublic` 新增 5 個發票欄位：`invoice_status`、`invoice_number`、`invoice_issued_at`、`invoice_response_code`、`invoice_response_message` |
| `api/routes/orders.py` | 新增批量查詢 `OrderInvoice` 子表邏輯，將發票資訊填充到 `OrderPublic` 回應 |

**前端修改：**

| 檔案 | 修改 |
|------|------|
| `client/models/order.ts` | `OrderPublic` interface 新增發票欄位 |
| `invoices.tsx` | 使用 `order.invoice_*` 真實資料、恢復綠界回應區塊、恢復發票狀態篩選功能 |
| `orders.tsx` | 恢復發票功能權限檢查、Badge 顯示、發票資訊顯示、InvoiceModal |

**資料流程：**
```
order_invoice 子表 → 後端 API JOIN → OrderPublic → 前端顯示
```

---

### 6. 發票管理頁面優化

**新增功能：**
- 新增副標題提示「只有已付款的訂單會有發票狀態」
- 建立 `plans/invoices-management-plan.md` 發票管理功能文件

**修復問題：**
- 修正「查看訂單」按鈕超出表格問題（操作欄位寬度 40px → 90px）
- 調整表格最小寬度（md: 750px, xl: 950px）
- 「查看訂單」按鈕樣式改為 `variant="lightBrand"`

**資料庫現況查詢：**

| 項目 | 數量 |
|------|------|
| 總訂單數 | 148 |
| 已付款 (PAID) | 47 |
| 待付款 (PENDING) | 100 |
| b2b_booth 訂單 | 94 |
| b2c_ticket 訂單 | 54 |

---

## Git Commits

1. `a39bab2` - refactor(order): V4 資料庫結構優化 - 拆分 order 表
2. `31a0715` - feat(invoice): 整合 order_invoice 子表至前端發票管理
3. `d176a64` - fix(invoices): 修正查看訂單按鈕超出表格問題
