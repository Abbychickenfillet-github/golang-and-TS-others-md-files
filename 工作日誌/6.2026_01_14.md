# 工作日誌 2026-01-14

## 今日完成事項

### 1. 調查 .gitignore 異動紀錄

**需求：** 確認 `.env` 檔案何時、被誰從 `.gitignore` 移除

**調查結果：**
- **Commit**: `f1fb658`
- **作者**: BrianNguyen291
- **時間**: 2026-01-03 16:23:42
- **操作**: 從 `.gitignore` 移除 `.env`

---

### 2. 修復 calculate-electricity-cost API 400 錯誤

**問題：** `/event/{id}/register/electricity` 頁面載入時 API 回傳 400 錯誤

**錯誤訊息：**
```json
{"detail":"所需電量必須大於 0"}
```

**原因：** 前端 `wattage` 初始值是 `0`，自動計算條件是 `wattage >= 0`（包括 0），但後端要求 `wattage > 0`

**修復內容：**

| 檔案 | 修改 |
|------|------|
| `official_website/src/pages/EventRegisterElectricityPage.tsx` | 自動計算條件改為 `wattage > 0`，並在 `wattage === 0` 時清空計算結果 |

**程式碼變更：**
```javascript
// Before (bug)
if (orderId && wattage >= 0 && !wattageError) {
  electricityApi.calculateElectricityCost(...)
}

// After (fixed)
if (orderId && wattage > 0 && !wattageError) {
  electricityApi.calculateElectricityCost(...)
} else if (wattage === 0) {
  setCalculatedCost(null)
}
```

**文件：** `official_website/docs/error/calculate-electricity-cost.md`

---

### 3. 重構電費計算邏輯

**問題：** `orders.py` 和 `registration_service.py` 有重複的電費計算邏輯

**解決方案：** 將電費計算抽取為 `RegistrationService.calculate_electricity_cost` 靜態方法

**修改內容：**

| 檔案 | 修改 |
|------|------|
| `backend/app/services/registration_service.py` | 新增 `calculate_electricity_cost` 靜態方法（純計算，不寫入資料庫） |
| `backend/app/api/routes/orders.py` | 移除重複的計算邏輯，改為呼叫 `RegistrationService.calculate_electricity_cost` |

**統一的電費計算邏輯：**
```python
@staticmethod
def calculate_electricity_cost(
    session: Session,
    event_id: str,
    required_wattage: int,
    voltage: int = 110,
) -> dict:
    """
    計算電費（純計算，不寫入資料庫）

    Returns:
        dict: {
            "total_cost": Decimal,
            "units": int,
            "price_per_unit": Decimal,
            "wattage_unit": int,
            "currency": str
        }
    """
```

**同時移除：** `registration_service.py` 中未使用的 `cable_length` 相關邏輯（lines 206-210）

---

### 4. 修復付款準備失敗 500 錯誤

**問題：** `/event/{id}/register/payment` 頁面顯示「付款準備失敗」

**錯誤訊息：**
```
AttributeError: 'Order' object has no attribute 'deleted_at'
File "/app/app/api/routes/payments.py", line 68
```

**原因：**
1. V4 資料庫重構（2026-01-13）已移除 `order.deleted_at` 欄位
2. `payments.py` 仍檢查 `order.deleted_at is not None`
3. Order 模型沒有 `deleted_at` 屬性，導致 AttributeError

**修復內容：**

| 檔案 | 修改 |
|------|------|
| `backend/app/api/routes/payments.py` | 將 `deleted_at` 檢查改為 `status == CANCELLED` 檢查 |

**程式碼變更：**
```python
# Before (bug)
if order.deleted_at is not None:
    raise HTTPException(status_code=400, detail="訂單已刪除")

# After (fixed)
order_status_value = order.status.value if isinstance(order.status, OrderStatus) else order.status
if order_status_value == OrderStatus.CANCELLED.value:
    raise HTTPException(status_code=400, detail="訂單已取消，無法發起支付")
```

**文件：** `official_website/docs/error/付款準備失敗.md`

**額外修復：** V4 重構後遺留的 `deleted_at` 引用

| 檔案 | 修改 |
|------|------|
| `backend/app/api/routes/payments.py` | 新增 `OrderStatus` import |
| `backend/app/services/payment_service.py` | 兩處 `deleted_at` 改為 `status == CANCELLED` 檢查 |
| `backend/app/services/refund_service.py` | 新增 `OrderStatus` import，`deleted_at` 改為 `status` 檢查 |
| `backend/app/api/routes/orders.py` | 移除 `deleted_at is not None` 檢查（758, 770 行）|
| `backend/app/utils/database/crud_helpers.py` | `delete_order` 改為設定 `status = CANCELLED` |

---

### 5. Docker Compose 並行建構問題

**問題：** `docker compose up --build backend` 時出現錯誤

**錯誤訊息：**
```
ERROR: image "docker.io/library/futuresignreg.combackend:latest": already exists
```

**原因：** `docker-compose.yml` 中 `backend` 和 `prestart` 使用同一個 image name，並行建構時發生衝突

**解決方案：**
```bash
# 方法 1: 串行建構
COMPOSE_PARALLEL_LIMIT=1 docker compose build backend && docker compose up -d backend

# 方法 2: 直接啟動（不重建）
docker compose up -d backend
```

**文件：** `abby-notes/docker/並行串行.md`

---

### 6. CORS/Redis 調查檢討

**問題：** 用戶報告 port 3000 有 CORS 錯誤

**調查過程錯誤：**
1. 假設用戶使用 `localhost:3000` 訪問
2. 發現 Redis 連線錯誤後，誤認為是根本原因
3. 沒有先確認用戶實際使用的 URL

**實際原因：** 用戶使用 `http://172.18.16.1:3000`（Docker 內部 IP），不在 CORS 白名單

**教訓：** 調查 CORS 問題時，**先確認用戶實際訪問的 URL**

---

### 7. 修復 order_uuid 欄位名稱

**問題：** Summary API 回傳 `order_uuid` 欄位，但 Order 模型實際欄位名為 `order_number`

**修復內容：**

| 檔案 | 修改 |
|------|------|
| `backend/app/models/order_summary.py` | `order_uuid` → `order_number`，新增 `event_name` 欄位 |
| `backend/app/api/routes/orders.py` | `order_uuid=` → `order_number=` |
| `official_website/src/lib/api/types.ts` | `order_uuid` → `order_number` |
| `official_website/src/pages/EventRegisterPaymentPage.tsx` | 使用 `order_number` |
| `official_website/src/pages/MyOrderDetailPage.tsx` | 使用 `order_number` |

---

## 建立的文件

| 文件 | 說明 |
|------|------|
| `official_website/docs/error/request-code.md` | request-code API Referrer Policy 調查紀錄 |
| `official_website/docs/error/calculate-electricity-cost.md` | 電費計算 API 400 錯誤修復紀錄 |
| `official_website/docs/error/付款準備失敗.md` | 付款準備 API 500 錯誤修復紀錄 |
| `abby-notes/docker/並行串行.md` | Docker Compose 並行/串行建構說明 |

---

## 待確認事項

- [ ] `request-code` API 是否真的有錯誤？需要用戶提供 Console 面板截圖
- [ ] 前端頁面是否需要支援 `172.18.16.1:3000` 訪問？

---

## Git Commits

1. 電費計算重構 - 統一 `registration_service.py` 和 `orders.py` 的計算邏輯
2. 修復付款準備失敗 - `payments.py` 移除無效的 `deleted_at` 檢查
