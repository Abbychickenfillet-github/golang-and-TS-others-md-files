# 今日工作日誌 (2026/01/20 星期一)

## 📋 今日主題：環境變數載入順序與 Docker Compose 設定

---

## 💻 主要工作內容

### 1. 建立 ENV_GUIDE.md 環境變數指南

建立了完整的環境變數載入順序說明文件，涵蓋四種工具：
- Docker Compose
- Vite (前端)
- Go Backend
- Python FastAPI

### 2. Docker Compose 環境變數設定

#### 載入順序（後者覆蓋前者）
```
1. .env                           # 基礎設定
2. .env.local                     # 本地覆蓋（如存在）
3. .env.${ENVIRONMENT}            # 環境特定（staging/production）
4. environment: 區塊              # 最高優先級 ✅
```

#### 修改 docker-compose.yml 支援 .env.local
```yaml
env_file:
  - .env
  - path: .env.local
    required: false          # 可選，不存在不報錯
  - .env.${ENVIRONMENT:-staging}
```

### 3. 重要觀念：Shell 環境變數 vs .env 檔案

**重點**：`docker-compose.yml` 中的 `${ENVIRONMENT:-staging}` 會優先讀取 **shell 環境變數**，不是 `.env` 檔案中的值！

因為 Docker Compose 在解析 `env_file:` 路徑時，`.env` 還沒被載入。

### 4. 終端機指令

```bash
# Windows (PowerShell) - 開發環境
$env:ENVIRONMENT="staging"; docker compose up

# Windows (PowerShell) - 生產環境
$env:ENVIRONMENT="production"; docker compose up -d

# Windows (PowerShell) - Watch 模式
$env:ENVIRONMENT="staging"; docker compose watch
```

### 5. ENVIRONMENT 驗證規則 (pydantic)

Python backend 使用 pydantic 的 `Literal` 類型驗證 `ENVIRONMENT`：

```python
# backend/app/core/config.py
ENVIRONMENT: Literal["local", "staging", "production"] = "production"
```

**只允許三個值**：`local`、`staging`、`production`

原本使用 `development` 會報錯，改為使用 `staging`。

### 6. ${VAR} vs ${VAR:-default} 的差異

| 寫法 | 意義 | 值從哪來 |
|------|------|----------|
| `${ENVIRONMENT:-staging}` | 有預設值 | Shell 環境變數 → 如果沒有，用 `staging` |
| `${MYSQL_HOST}` | 沒有預設值 | 已載入的 env_file |

**重點**：`MYSQL_HOST` 來自 `.env.staging` 檔案，不是終端機！

### 7. environment: 區塊內變數的覆蓋規則

`environment:` 區塊內的變數是**各自獨立**的，不會互相覆蓋：

```yaml
environment:
  - ENVIRONMENT=staging    # 只影響 ENVIRONMENT 這個變數
  - MYSQL_HOST=xxx         # 只影響 MYSQL_HOST 這個變數
```

每個變數有自己獨立的覆蓋鏈，不會互相影響。

---

## 🔧 問題排解

### Port 8003 被佔用

**錯誤訊息**：
```
Error response from daemon: Bind for 0.0.0.0:8003 failed: port is already allocated
```

**原因**：`backend-go` 容器還在運行，佔用了 8003 port。

**解決方案**：
```bash
# 停止所有容器
docker compose down

# 重新啟動
$env:ENVIRONMENT="staging"; docker compose up
```

---

## 📝 新增筆記

### Abby-notes/待辦事項/MD格式-ASCII表格轉換.md

記錄了 CLI 輸出的 ASCII 表格（`┌───┬───┐`）在 Markdown 中會對不齊的問題。

**解決方案**：使用 Markdown 表格格式 `| |` 取代 ASCII 表格。

---

## 📁 今日修改的檔案

| 檔案 | 變更 |
|------|------|
| `ENV_GUIDE.md` | 新建，完整的環境變數載入順序說明 |
| `docker-compose.yml` | 修改預設值 `staging`，加入 `.env.local` 支援 |
| `.env.staging` | 已存在，`ENVIRONMENT=staging` |
| `Abby-notes/待辦事項/MD格式-ASCII表格轉換.md` | 新建，ASCII 表格轉換說明 |

---

## 🌐 環境名稱的業界標準定義

| 環境 | 意義 | 部署位置 | 用途 |
|------|------|----------|------|
| `local` | 本地開發 | 你的電腦 | 開發、debug |
| `development` | 開發環境 | 共享伺服器（可選） | 團隊開發測試 |
| `staging` | 預發布環境 | 伺服器 | 部署前最終驗證 |
| `production` | 生產環境 | 伺服器 | 面向最終用戶 |

### 本專案的環境定義

| 環境 | 用途 | 資料庫 |
|------|------|--------|
| `local` | 本地開發，連本地 DB | 本地 MySQL |
| `staging` | 本地開發，連遠端測試 DB | `future_sign_stage` |
| `production` | 正式部署 | `future_sign_prod` |

---

## 📚 參考資料

- [Docker Best Practices: Using ARG and ENV in Your Dockerfiles](https://www.docker.com/blog/docker-best-practices-using-arg-and-env-in-your-dockerfiles/)

---

## 💡 今日學習重點

1. **Shell 環境變數優先於 .env 檔案**：Docker Compose 解析路徑時 `.env` 還沒載入
2. **environment: 區塊最高優先**：會覆蓋 env_file 載入的同名變數
3. **變數各自獨立**：不同變數名不會互相覆蓋
4. **${VAR:-default} 語法**：有預設值的變數可以被終端機覆蓋
5. **pydantic Literal 驗證**：限制環境變數只能是特定值
