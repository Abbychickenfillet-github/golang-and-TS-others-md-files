# 工作日誌 2026-01-12

## 今日完成事項

### 1. 新增綠界發票回應欄位

**需求：** 發票管理頁面需要顯示綠界 API 的回傳代碼和訊息，原本是硬編碼。

**修改內容：**

| 檔案 | 修改 |
|------|------|
| `backend/app/models/order.py` | Order 模型新增 `invoice_response_code` 和 `invoice_response_message` 欄位 |
| `backend/sql/163_add_invoice_response_fields.sql` | MySQL 遷移腳本 |
| `frontend/src/client/models/order.ts` | OrderPublic 新增對應欄位 |
| `frontend/src/routes/_layout/invoices.tsx` | 條件式顯示綠界回應（成功綠色/錯誤紅色） |

**綠界常見回傳代碼：**
- `1` - 成功
- `10200047` - 發票編號重覆
- `10200019` - 統編格式錯誤

---

### 2. 訂單管理頁面新增「退款申請」分頁

**需求：** 快速篩選「申請取消中」狀態的訂單。

**修改內容：**
- `frontend/src/routes/_layout/orders.tsx` - TabList 新增「退款申請」Tab
- 篩選邏輯：`order.status === "CANCELLATION_REQUESTED"`

---

### 3. 修復活動管理頁面記憶體問題（重要）

**問題：** 同事反映打開 `/events` 頁面時記憶體快爆炸。

**原因分析：**

Chakra UI 的 `<Tabs>` 元件預設會**同時渲染所有 TabPanel**，即使 Tab 未被選中。

在 `events.tsx` 中，每個 Accordion 項目有 5 個 Tab：
1. `EventStatsCard` - 發出 2 個 API 請求
2. `BoothsPanel` - 發出 API 請求
3. `OrdersPanel` - 發出 API 請求
4. `OrderElectricityPanel` - 發出 API 請求
5. `OrderItemsPanel` - 發出 API 請求

**假設頁面顯示 50 個活動：**
- 50 × 5 個 Tab = 250 個面板同時渲染
- 每個 EventStatsCard 發 2 個請求 = 100+ 個 API 請求
- 大量元件同時存在於記憶體中

**解決方案：**

在 `<Tabs>` 元件加上 `isLazy` 屬性：

```tsx
// 修復前
<Tabs size="sm" variant="enclosed" colorScheme="teal">

// 修復後
<Tabs size="sm" variant="enclosed" colorScheme="teal" isLazy>
```

**影響：**

| 項目 | 修復前 | 修復後 |
|------|--------|--------|
| Tab 渲染時機 | 所有 Tab 同時渲染 | 只有點擊時才渲染 |
| 50 個活動的 API 請求 | ~250+ 個 | 只有展開並點擊的 Tab |
| 記憶體使用 | 大量元件同時存在 | 按需載入 |

**修改檔案：**
- `frontend/src/routes/_layout/events.tsx` (第 1273 行)

---

## 學習筆記

### Chakra UI Tabs 的 isLazy 屬性

```tsx
// 預設行為：所有 TabPanel 都會渲染（即使未顯示）
<Tabs>
  <TabPanels>
    <TabPanel><ExpensiveComponent1 /></TabPanel>  {/* 會渲染 */}
    <TabPanel><ExpensiveComponent2 /></TabPanel>  {/* 會渲染 */}
    <TabPanel><ExpensiveComponent3 /></TabPanel>  {/* 會渲染 */}
  </TabPanels>
</Tabs>

// 加上 isLazy：只渲染目前選中的 Tab
<Tabs isLazy>
  <TabPanels>
    <TabPanel><ExpensiveComponent1 /></TabPanel>  {/* 選中時才渲染 */}
    <TabPanel><ExpensiveComponent2 /></TabPanel>  {/* 選中時才渲染 */}
    <TabPanel><ExpensiveComponent3 /></TabPanel>  {/* 選中時才渲染 */}
  </TabPanels>
</Tabs>
```

**何時使用 isLazy：**
- Tab 內容有 API 請求
- Tab 內容是複雜元件
- 有多個 Tab（尤其是在列表中重複渲染時）

**為什麼 isLazy 只需要加在 `<Tabs>` 上？**

`isLazy` 是加在父層 `<Tabs>` 元件，不需要加在個別的 `<Tab>` 或 `<TabPanel>` 上：

```tsx
// 正確用法 - isLazy 加在 Tabs 上
<Tabs isLazy>
  <TabList>
    <Tab>Tab 1</Tab>      {/* 不需要加 isLazy */}
    <Tab>Tab 2</Tab>
  </TabList>
  <TabPanels>
    <TabPanel>內容 1</TabPanel>  {/* 不需要加 isLazy */}
    <TabPanel>內容 2</TabPanel>
  </TabPanels>
</Tabs>
```

**原理：**
- `<Tabs>` 是容器，控制整體行為
- `isLazy` 告訴 Tabs：「只在 TabPanel 被選中時才渲染它」
- 個別的 `<Tab>` 和 `<TabPanel>` 不需要知道這個設定
- 這是 Chakra UI 的設計模式 — 配置放在父層，子層自動繼承行為

---

### 4. 其他頁面加上 isLazy

檢查所有使用 `<Tabs>` 的頁面，為需要的頁面加上 `isLazy`：

| 檔案 | 有 TabPanels? | 內容有 API 請求? | 需要 isLazy? |
|------|--------------|-----------------|-------------|
| `events.tsx` | ✅ 5 個面板 | ✅ 每個都有 | **已修復** |
| `events/$eventId.tsx` | ✅ 3 個 Section | ✅ 各自查詢 | **已修復** |
| `member-positions.tsx` | ✅ PositionList | ✅ 可能有 | **已修復** |
| `companies.tsx` | ❌ 導航用 | - | 不需要 |
| `orders.tsx` | ❌ 導航用 | - | 不需要 |
| `TicketsSidebar.tsx` | ✅ | ❌ 資料已在外層載入 | 不需要 |
| `MemberDetailModal.tsx` | ✅ | ❌ 資料已在外層載入 | 不需要 |

---

### 5. 建立 OrderElectricityPanel 字型調整計畫

**計畫檔案：** `docs/plans/order-electricity-panel-font-size-plan.md`

**目前字型統整：**

| 大小 | 數量 | 用途 |
|------|------|------|
| `fontSize="2xs"` | 1 | 電壓 Badge |
| `fontSize="xs"` | 6 | StatLabel、提示文字 |
| `fontSize="sm"` | 6 | 表格內容 (Td) |
| `fontSize="xl"` | 4 | StatNumber（統計數字）|
| `size="sm"` | 3 | Heading、Table、Button |

**調整方向：**
- `2xs` → `xs`
- `xs` → `sm`
- `sm` → `md`
- `xl` 維持不變
- Heading `size="sm"` → `size="md"`

---

### 6. ElectricityManagementPanel 欄位調整

**需求：** 簡化電力需求管理頁面的表格欄位，改善可讀性。

**修改檔案：** `frontend/src/components/Orders/ElectricityManagementPanel.tsx`

**修改內容：**

| 變更 | 說明 |
|------|------|
| 移除「數量」欄位 | 原本獨立顯示的數量欄位已無意義 |
| 移除「設備名稱」欄位 | 簡化表格 |
| 合併數量到瓦數 | `500W` → `500W ×3`（數量 > 1 時才顯示） |
| 欄位寬度調整 | `2fr 2fr 1fr 1fr 1fr 1fr 1fr 1fr auto` |
| 防止折行 | 成立時間加上 `whiteSpace="nowrap"` |

**Grid templateColumns 調整：**

```tsx
// 修改前
md: "150px 150px 80px 60px 60px 80px 60px 100px 100px auto"

// 修改後 - 使用 fr 單位平均分配
md: "2fr 2fr 1fr 1fr 1fr 1fr 1fr 1fr auto"
```

**瓦數顯示邏輯：**

```tsx
// 當數量 > 1 時顯示 ×數量
{electricity.wattage.toLocaleString()}W
{electricity.quantity > 1 && ` ×${electricity.quantity}`}
// 例如：500W ×3
```

---

## Git Commits

1. `ffaba9c` - feat(orders): 新增綠界發票回應欄位與退款申請分頁
2. `945f812` - perf(events): 修復活動頁面記憶體問題，加上 Tabs isLazy
3. `e3d1c36` - perf: 為 Tabs 元件加上 isLazy 避免不必要渲染
4. `3c4bfa8` - style: UI 調整與字型放大
