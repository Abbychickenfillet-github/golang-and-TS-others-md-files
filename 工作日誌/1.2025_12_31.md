# 工作日誌 2025-12-31

## 廠商支付方式管理頁面 完整修改清單

---

## 一、後端資料庫關聯修改

### 1. Cascade 策略調整（`backend/app/models/event.py`）

| 項目 | 修改前 | 修改後 |
|------|--------|--------|
| 策略 | `"all, delete-orphan"` | `"save-update, merge"` |
| 效果 | 刪活動 → 子資料自動刪 | 刪活動 → 子資料保留 |
| 用途 | 防止孤兒資料 | 支援歷史紀錄查詢 |

```python
# 修改前：刪除活動會連帶刪除所有子資料
sa_relationship_kwargs={"cascade": "all, delete-orphan"}

# 修改後：子資料獨立保留，可查歷史
sa_relationship_kwargs={"cascade": "save-update, merge"}
```

---

## 二、資料清理

### 2. 清除孤兒資料（直接操作資料庫）

```sql
-- 找出 company_id 對不到公司的支付方式記錄
-- 共發現 7 筆孤兒資料，已刪除
DELETE FROM vendor_payment_methods
WHERE company_id NOT IN (SELECT id FROM company);
```

---

## 三、前端 Bug 修復

### 3. 活動名稱顯示 ID → 顯示中文名稱

**問題**：活動名稱顯示 UUID（如 `7eca8659-143d-4d7f-af17-21acff827da9`）

**原因**：API 回傳格式判斷錯誤

```typescript
// 修改前（錯誤）：以為 API 回傳 { data: [], count: n }
const { data: eventsData } = useQuery({
  queryFn: () => ... as Promise<{ data: EventPublic[]; count: number }>,
})
eventsData?.data?.forEach(...)  // eventsData.data 是 undefined！

// 修改後（正確）：API 直接回傳陣列
const { data: eventsData } = useQuery({
  queryFn: () => ... as Promise<EventPublic[]>,
})
if (Array.isArray(eventsData)) {
  eventsData.forEach(...)  // 正確遍歷
}
```

### 4. 刪除 DEBUG JSON 區塊

移除頁面底部的 `<Accordion>` 原始 JSON 顯示區塊（開發用，正式環境不需要）

---

## 四、前端版面新增功能

### 5. 分頁功能（Pagination）

**新建元件**：`frontend/src/components/Common/Pagination.tsx`

| 功能 | 說明 |
|------|------|
| 頁碼按鈕 | 顯示 1, 2, 3... 頁碼，支援點擊跳轉 |
| 省略號 | 頁數多時顯示 1 ... 5 6 7 ... 20 |
| 上下頁 | `<` `>` 按鈕 |
| 首尾頁 | `<<` `>>` 快速跳轉 |
| 顯示資訊 | 「顯示 1-20 / 共 156 筆」 |

### 6. 篩選條件區塊強化

| 篩選項目 | 說明 |
|----------|------|
| 活動 | 下拉選單，顯示中文活動名稱 |
| 支付方式 | 悠遊付 / Taiwan Pay / Line Pay / icash |
| 統編狀態 | 有統編（台灣公司）/ 無統編（可能是國外公司）|
| 公司狀態 | Checkbox「包含停用的公司」|
| 建立時間 | 從/到 日期選擇器 |
| 更新時間 | 從/到 日期選擇器 |

### 7. 表格顯示優化

| 欄位 | 優化內容 |
|------|----------|
| 統編 | 無統編顯示「可能是國外公司」|
| 公司名稱 | 資料遺失顯示「公司資料遺失」|
| 活動名稱 | 從 ID 改為顯示中文名稱 |

---

## 五、Excel 匯出功能強化

### 8. 篩選條件顯示在 Excel 標題

```
┌─────────────────────────────────────────────────────────────────────┐
│ 廠商支付方式匯出  —  活動：亞洲香水節 | 支付方式：悠遊付 | 僅營運中公司  │ ← 第1列
├─────────────────────────────────────────────────────────────────────┤
│ 匯出時間：2025-12-31 08:30 (UTC+0，台灣時間 +8 小時 = 16:30) | 共 25 筆  │ ← 第2列
├─────────────────────────────────────────────────────────────────────┤
│ 公司名稱 │ 品牌名稱 │ 統編 │ 聯繫窗口 │ ... │                        │ ← 第4列
└─────────────────────────────────────────────────────────────────────┘
```

### 9. 匯出時間格式優化

```python
# 修改前
匯出時間：2025-12-31 08:30 UTC

# 修改後（讓行政人員更容易理解）
匯出時間：2025-12-31 08:30 (UTC+0，台灣時間 +8 小時 = 16:30)
```

### 10. 匯出按鈕 Tooltip

滑鼠移到「匯出 Excel」按鈕時顯示：
> 「根據目前的篩選條件匯出 Excel，篩選條件會顯示在檔案首列」

### 11. 中文檔名支援

```python
# 修改前（會報錯）
headers={"Content-Disposition": f"attachment; filename=廠商支付_香水節.xlsx"}

# 修改後（使用 RFC 5987 格式）
from urllib.parse import quote
encoded = quote("廠商支付_香水節.xlsx")
headers={"Content-Disposition": f"attachment; filename*=UTF-8''{encoded}"}
```

---

## 六、新增篩選參數（後端 API）

### `GET /api/v1/vendor-payment-methods/export`

| 參數 | 說明 |
|------|------|
| `event_id` | 活動 ID |
| `event_name` | 活動名稱（顯示在 Excel 標題）|
| `payment_type` | 支付方式篩選 |
| `tax_id_status` | 統編狀態（has_tax_id / no_tax_id）|
| `include_inactive` | 是否包含停用公司（預設 false）|

---

## 七、筆記文件

### 建立的筆記

| 檔案 | 內容 |
|------|------|
| `Abby-notes/backend-error-log/2025-12-31-api-response-format-mismatch.md` | API 回傳格式問題（活動名稱顯示 ID）|
| `Abby-notes/backend-error-log/2025-12-31-http-header-chinese-encoding.md` | HTTP Header 中文編碼問題（Latin-1 / RFC 5987）|
| `Abby-notes/Python語法解釋/sqlalchemy-relationship-cascade.md` | SQLAlchemy cascade 選項詳解 |
| `Abby-notes/git-branch-notes.md` | Git 分支問題筆記 |

---

## 八、修改檔案清單

| 檔案 | 修改類型 |
|------|----------|
| `backend/app/models/event.py` | cascade 策略修改 |
| `backend/app/models/vendor_payment_method.py` | 新增 company_status 欄位 |
| `backend/app/services/vendor_payment_method_service.py` | Excel 匯出強化 |
| `backend/app/api/routes/vendor_payment_methods.py` | API 參數新增 |
| `frontend/src/components/Common/Pagination.tsx` | **新建** 共用分頁元件 |
| `frontend/src/components/Common/SidebarItems.tsx` | 側邊欄顏色調整（紫/藍/橙）|
| `frontend/src/routes/_layout/vendor-payment-methods.tsx` | 頁面功能大幅強化 |

---

## 九、側邊欄顏色調整

同事建議改用花俏一點的顏色，不要用黃色（brand色系）

| 分組 | 修改前 | 修改後 |
|------|--------|--------|
| 公司相關 | brand 色系 | 紫色 (purple.600/50/400) |
| 活動相關 | brand 色系 | 藍色 (blue.600/50/400) |
| 訂單相關 | brand 色系 | 橘色 (orange.600/50/400) |

---

## 十、頁面使用說明功能（Help Modal）

### 12. 新增書本 icon 按鈕

**位置**：頁面標題右上角

**實作方式**：
```typescript
// 使用 Chakra UI 的 useDisclosure hook 控制 Modal 開關
const { isOpen: isHelpOpen, onOpen: onHelpOpen, onClose: onHelpClose } = useDisclosure()

// 標題列加入 Flex 容器，放置書本按鈕
<Flex justify="space-between" align="center">
  <Heading>廠商支付方式管理</Heading>
  <Tooltip label="頁面使用說明">
    <IconButton icon={<FiBook />} onClick={onHelpOpen} />
  </Tooltip>
</Flex>
```

### 13. 使用說明 Modal 內容

| 區塊 | 顏色 | 說明內容 |
|------|------|----------|
| 頁面功能 | 紫色 | 說明本頁用於管理廠商支付方式 |
| 篩選條件 | 藍色 | 活動、支付方式、統編、公司狀態、時間篩選 |
| Excel 匯出 | 綠色 | 套用篩選條件、標題顯示、時間對照 |
| 注意事項 | 橘色 | 公司資料遺失、國外公司、資料來源說明 |

**使用的 Chakra UI 元件**：
- `Modal`, `ModalOverlay`, `ModalContent`, `ModalHeader`, `ModalBody`, `ModalCloseButton`
- `UnorderedList`, `ListItem`
- `useDisclosure` hook

---

## 十一、日期篩選與排序功能修復

### 14. 日期篩選時區 Bug 修復

**問題**：選擇 2025/12/13 到 2025/12/19，結果只顯示 19 號的資料

**原因**：JavaScript `new Date()` 的時區解析差異

```typescript
// 問題：不加時間時，JavaScript 解析為 UTC 時區
new Date("2025-12-13")
// → 2025-12-13 00:00:00 UTC = 2025-12-13 08:00:00 台灣時間

// 修正：加上時間，JavaScript 解析為本地時區
new Date("2025-12-13T00:00:00")
// → 2025-12-13 00:00:00 台灣時間
```

**解決方案**：
```typescript
// 修改前
const from = new Date(createdFrom)

// 修改後
const from = new Date(createdFrom + "T00:00:00")
const to = new Date(createdTo + "T23:59:59")
```

### UTC vs 本地時區（補充說明）

```
UTC 時區（世界標準時間）
├─ 倫敦的時間（冬季）
├─ 全球統一的參考時間
└─ 資料庫通常存 UTC

台灣時區（UTC+8）
├─ 比 UTC 快 8 小時
└─ 我們日常看到的時間
```

**實際例子**：

| 台灣時間 | UTC 時間 |
|----------|----------|
| 2025-12-13 **08:00** | 2025-12-13 **00:00** |
| 2025-12-13 **00:00**（午夜） | 2025-12-**12** **16:00**（前一天下午） |

**為什麼日期篩選會出錯**：

```javascript
// 用戶在台灣選擇 "從 2025-12-13 開始"
// 心裡想的是：台灣時間 12/13 午夜 00:00 之後的資料

new Date("2025-12-13")  // 不加時間
// JavaScript 解析成 UTC 午夜 = 台灣早上 8 點
// 結果：早上 8 點之前的資料都被過濾掉了！

new Date("2025-12-13T00:00:00")  // 加上時間
// JavaScript 解析成本地午夜 = 台灣午夜 00:00
// 結果：正確包含 12/13 凌晨的資料
```

**JavaScript Date 解析規則**：

| 寫法 | 解析成 |
|------|--------|
| `new Date("2025-12-13")` | UTC 午夜 |
| `new Date("2025-12-13T00:00:00")` | **本地**午夜 |
| `new Date("2025-12-13T00:00:00Z")` | UTC 午夜（Z = Zulu = UTC） |

### 15. 建立時間排序功能

**功能**：表格「建立時間」欄位新增排序按鈕

| 狀態 | 圖示 | 說明 |
|------|------|------|
| 降冪（預設）| ↓ | 新→舊 |
| 升冪 | ↑ | 舊→新 |

**實作方式**：
```typescript
// 狀態
const [sortOrder, setSortOrder] = useState<"asc" | "desc">("desc")

// 排序邏輯
const sortedData = useMemo(() => {
  return [...filteredData].sort((a, b) => {
    const dateA = new Date(a.created_at).getTime()
    const dateB = new Date(b.created_at).getTime()
    return sortOrder === "asc" ? dateA - dateB : dateB - dateA
  })
}, [filteredData, sortOrder])
```

**使用說明 Modal 更新**：新增「排序」說明項目

---

## 十二、單元測試建立

### 16. 後端 pytest 測試

**新建檔案**：`backend/app/tests/api/routes/test_vendor_payment_methods.py`

**測試項目**：

| 測試函數 | 說明 |
|----------|------|
| `test_list_vendor_payment_methods` | 測試列出廠商支付方式 |
| `test_list_vendor_payment_methods_with_filters` | 測試帶篩選條件的列表 |
| `test_list_vendor_payment_methods_with_company` | 測試含公司資訊的列表 |
| `test_list_vendor_payment_methods_pagination` | 測試分頁功能 |
| `test_get_vendor_payment_method_not_found` | 測試取得不存在的記錄 |
| `test_get_vendor_payment_method_statistics` | 測試統計 API |
| `test_export_vendor_payment_methods` | 測試 Excel 匯出 |
| `test_export_vendor_payment_methods_with_filters` | 測試帶篩選的匯出 |
| `test_get_vendor_payment_method_by_company_not_found` | 測試根據公司查詢 |

### 17. 前端 Vitest 測試（待建立）

需要測試的項目：
- `Pagination` 元件
- `vendor-payment-methods` 頁面篩選邏輯

---

## 十三、Git 操作筆記

### 18. Git Merge 衝突處理

**問題**：執行 `git merge --no-ff develop` 時出錯

```
error: Your local changes to the following files would be overwritten by merge:
        .gitignore
        frontend/src/routeTree.gen.ts
Please commit your changes or stash them before you merge.
```

**原因**：有未 commit 的本地修改，Git 怕 merge 會覆蓋

**解決方法**：

```bash
# 方法 1：stash 暫存（推薦）
git stash              # 暫時藏起來
git merge --no-ff develop
git stash pop          # 拿出來

# 方法 2：放棄本地修改
git checkout -- .gitignore frontend/src/routeTree.gen.ts
git merge --no-ff develop

# 方法 3：先 commit
git add .gitignore frontend/src/routeTree.gen.ts
git commit -m "chore: update files"
git merge --no-ff develop
```

### 為什麼 `git add .` 不能直接 merge？

```
工作流程：
                   git add          git commit
你的修改  ──────────→  暫存區  ──────────→  本地儲存庫
   │                    │
   └── merge 會覆蓋 ────┘

git add 只是「準備要存」，還沒真正存好
Git merge 說：「你有東西還沒存好，我不敢動」
```

---

## 十四、PR 撰寫

### 19. PR 內容範本

**Title:**
```
feat(vendor-payment): 廠商支付方式管理頁面大幅強化 + 側邊欄配色優化
```

**Body:**
```markdown
## Summary

### 廠商支付方式管理頁面（vendor-payment-methods）
- 新建共用 Pagination 元件
- 修復活動名稱顯示 UUID 問題
- 新增多項篩選條件
- 修復日期篩選時區 Bug
- 新增建立時間排序功能
- 新增頁面使用說明 Modal
- 表格優化
- 匯出按鈕 Tooltip

### 後端修改
- cascade 策略調整
- 新增 company_status 欄位
- Excel 匯出強化
- 新增 API 參數
- RFC 5987 中文檔名編碼

### 側邊欄配色優化
- 公司相關：紫色
- 活動相關：藍色
- 訂單相關：橘色

## Test plan
- [ ] 測試廠商支付方式頁面篩選功能
- [ ] 測試日期範圍篩選（確認時區正確）
- [ ] 測試排序功能
- [ ] 測試 Excel 匯出
- [ ] 測試頁面使用說明 Modal
- [ ] 確認側邊欄顏色顯示正確
```

**注意**：PR 要選擇 target `develop` 分支，不是 `main`！

---

## 十五、更新時間排序功能

### 20. 新增 sortField 狀態

**需求**：除了建立時間，也要能依更新時間排序

**實作**：
```typescript
// 新增 sortField 狀態
const [sortField, setSortField] = useState<"created_at" | "updated_at">("created_at")
const [sortOrder, setSortOrder] = useState<"asc" | "desc">("desc")

// 排序邏輯
const sortedData = useMemo(() => {
  return [...filteredData].sort((a, b) => {
    const valueA = sortField === "created_at" ? a.created_at : a.updated_at
    const valueB = sortField === "created_at" ? b.created_at : b.updated_at
    const dateA = valueA ? new Date(valueA).getTime() : 0
    const dateB = valueB ? new Date(valueB).getTime() : 0
    return sortOrder === "asc" ? dateA - dateB : dateB - dateA
  })
}, [filteredData, sortField, sortOrder])
```

**UI 設計**：
- 藍色按鈕 = 目前排序的欄位
- 灰色按鈕 = 點擊可切換到這個欄位
- 點擊已選中的欄位 = 切換升冪/降冪

**注意**：一次只能選一個欄位排序，不支援多欄位排序

---

## 十六、側邊欄分組問題（再次發生）

### 21. 問題描述

**現象**：merge develop 後，「電力需求管理」和「插座規格管理」跑出群組外

**原因**：develop 分支新增「插座規格管理」時忘記加 `group: "order"`

**修復**：
```typescript
// 修復前
{
  icon: FiZap,
  title: "電力需求管理",
  path: "/order-electricity",
  permission: "order_electricity.view",
  // 缺少 group!
}

// 修復後
{
  icon: FiZap,
  title: "電力需求管理",
  path: "/order-electricity",
  permission: "order_electricity.view",
  group: "order",  // ← 加上這行
}
```

**預防措施**：在 `items` 陣列前加上註解提醒
```typescript
/**
 * ⚠️ 新增項目時請注意：
 * 1. 公司相關功能 → 加上 group: "company"
 * 2. 活動相關功能 → 加上 group: "event"
 * 3. 訂單相關功能 → 加上 group: "order"
 * 4. 不屬於任何群組的才不用加 group
 */
const items: SidebarItem[] = [...]
```

**釐清**：這不是 merge 覆蓋問題，而是 develop 新增的項目本來就沒有 group
