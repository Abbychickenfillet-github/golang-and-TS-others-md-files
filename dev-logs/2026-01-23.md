# 開發日誌 2026-01-23

## 今日摘要

整理個人筆記、處理 docker compose 開發環境問題、將公司測試資料插入 staging 資料庫。

---

## 問題與解答

### 1. Docker MySQL 插入中文資料變成亂碼

**現象:** 透過 `cat file.sql | docker run mysql` 插入資料後，中文顯示為亂碼（如 `å'Œé¢¨` 而非 `和風`）

**原因:** stdin 傳送 SQL 時，UTF-8 被當成 Latin-1 處理後又轉成 UTF-8（雙重編碼）

**解決方案:**
```bash
# 錯誤寫法
cat file.sql | docker run -i mysql:8 mysql -h host -u root -pXXX dbname

# 正確寫法（加入編碼設定）
docker run --rm -e LANG=C.UTF-8 -i mysql:8 mysql \
  -h host -u root -pXXX \
  --default-character-set=utf8mb4 \
  dbname < file.sql
```

**關鍵參數:**
- `-e LANG=C.UTF-8` - 設定容器 locale
- `--default-character-set=utf8mb4` - MySQL 客戶端使用 UTF-8
- 用 `< file.sql` 代替 `cat | ...`

---

### 2. 為何 `npm run dev` 是 5174 port 而不是 3000？

| 服務 | Port | 說明 |
|------|------|------|
| **frontend** (後台) | 5173 | Vite 預設 port |
| **official_website** (前台) | 5174 | Vite 預設第二個 port（5173 被佔用）|
| 3000 | - | Next.js 預設，本專案不使用 |
| Docker official_website | 3004 | docker-compose.yml 設定的 nginx port |

---

### 3. `docker run` vs `docker compose` 的差異

| 指令 | 用途 | 範例 |
|------|------|------|
| `docker run` | 臨時執行單一容器 | `docker run --rm mysql:8 mysql -e "SELECT 1"` |
| `docker compose` | 管理 yml 定義的服務群組 | `docker compose up backend-go` |

**docker run 語法:**
```bash
docker run [OPTIONS] IMAGE [COMMAND]
```

---

### 4. `docker compose watch` 會自動啟動依賴服務

**現象:** 執行 `docker compose watch official_website` 會同時啟動 Python backend

**原因:** `docker-compose.yml` 中的 `depends_on` 設定
```yaml
official_website:
  depends_on:
    backend:
      condition: service_started
```

**解決方案:**
```bash
# 方法 1: 跳過依賴
docker compose watch official_website --no-deps

# 方法 2: 本地開發（推薦）
cd official_website && npm run dev
```

---

### 5. 開發前台網站的最佳方式

**建議:** 方案 A 較佳

```bash
# Terminal 1
docker compose watch backend-go

# Terminal 2
cd official_website
npm run dev
```

**原因:**
- `npm run dev` 熱更新是毫秒級，Docker 需要秒級 rebuild
- 有完整錯誤訊息和 Source Maps
- 少跑一個 container，資源佔用較低

---

### 6. `cat file.sql` 是省略寫法嗎？

**是的**，完整指令中 `file.sql` 是範例名稱，實際檔案是 `temp_insert_fixed.sql`。

完整指令範例：
```bash
docker run --rm -e LANG=C.UTF-8 -i mysql:8 mysql \
  -h hnd1.clusters.zeabur.com -P 32195 \
  -u root -p密碼 \
  --default-character-set=utf8mb4 \
  future_sign_stage < C:/coding/template/temp_insert_fixed.sql
```

---

### 7. 編碼設定要寫在腳本中還是命令列？

**兩種方式都可以：**

| 方式 | 語法 | 適用情境 |
|------|------|----------|
| 命令列 | `--default-character-set=utf8mb4` | 臨時執行、不想改腳本 |
| 腳本內 | `SET NAMES utf8mb4;` | 腳本要分享、確保一致性 |
| Docker 環境 | `-e LANG=C.UTF-8` | 設定容器 locale |

**SQL 腳本內設定編碼：**
```sql
SET NAMES utf8mb4;
SET CHARACTER SET utf8mb4;

INSERT INTO company VALUES (...);
```

**最佳實踐**：兩者都加更保險（命令列 + 腳本開頭）。

---

### 8. `mysql:8` 是什麼意思？

`mysql:8` 是 Docker 映像標籤，代表 **MySQL 8.0 版本**。

**版本說明：**
- MySQL 8.0 於 2018 年發布，是 5.7 的重大升級版
- 目前是長期支援版本（LTS），支援至 **2026 年 4 月**
- 後續版本：8.1、8.4 (LTS)、9.x

**8.0 vs 5.7 主要差異：**
| 特性 | MySQL 5.7 | MySQL 8.0 |
|------|-----------|-----------|
| 預設字元集 | latin1 | **utf8mb4** |
| JSON 支援 | 基本 | **原生支援** |
| 窗口函數 | 無 | **支援** |
| CTE (WITH) | 無 | **支援** |
| 資料字典 | 檔案式 | **交易式** |

**Docker 使用方式：**
```bash
docker run mysql:8           # 使用 8.x 最新版
docker run mysql:8.0         # 指定 8.0.x
docker run mysql:8.0.35      # 指定精確版本
docker run mysql:latest      # 最新版（可能是 9.x）
```

---

### 9. `docker run --rm` 的 `--rm` 是什麼？

`--rm` = **R**e**m**ove，容器執行完畢後**自動刪除**。

```bash
# 有 --rm：執行完自動刪除
docker run --rm mysql:8 mysql -e "SELECT 1"

# 沒有 --rm：容器會留著（Exited 狀態）
docker run mysql:8 mysql -e "SELECT 1"
```

| 情境 | 建議 |
|------|------|
| 一次性指令 | 用 `--rm` |
| 需要 debug | 不用 `--rm` |

---

### 10. `INSERT IGNORE` 的用途

當插入資料可能有重複 ID 時，使用 `INSERT IGNORE` 可以跳過重複而非報錯：

```sql
-- 會報錯（如果 ID 重複）
INSERT INTO company VALUES (...)

-- 跳過重複，不報錯
INSERT IGNORE INTO company VALUES (...)
```

---

## 執行的任務

### 1. 整理個人 MD 筆記
- 將 Abby 創建的 MD 檔案從 `docs/`、`frontend_docs/` 等位置移到 `Abby-notes/` 分類資料夾
- 建立 PR #195 到 develop 分支

### 2. 插入 Company 測試資料
- `future_sign_stage`：插入 23 筆公司資料
- `future_sign_stage_Go`：用 `INSERT IGNORE` 新增 6 筆（18→24）
- 修復編碼問題（使用 `--default-character-set=utf8mb4`）
- 角色包含：organizer、vendor、electricity_company、general_contractor

### 3. 建立 Docker 筆記
- `Abby-notes/docker/docker-compose-watch-vs-npm-dev.md`

---

## 建立/修改的檔案

| 檔案 | 說明 |
|------|------|
| `Abby-notes/docker/docker-compose-watch-vs-npm-dev.md` | Docker vs npm run dev 比較 |
| `Abby-notes/CLI/bash-claude/redirect-stderr.md` | 解釋 `2>/dev/null` |
| `Abby-notes/chore/MD_FILES_AUTHORS.md` | 更新清理狀態 |

---

## 學到的教訓

1. **Docker 執行 MySQL 時要注意編碼** - 使用 `--default-character-set=utf8mb4` 和 `LANG=C.UTF-8`
2. **`docker compose watch --no-deps`** - 可以跳過依賴服務的啟動
3. **開發前台用 npm run dev 較佳** - 比 Docker 更快且有更好的 debug 體驗
