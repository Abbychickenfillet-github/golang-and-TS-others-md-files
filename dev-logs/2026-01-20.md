# 開發日誌 2026-01-20

## 今日摘要

修復 Backend-Go 多項啟動問題，包括 AutoMigrate 外鍵衝突、Model 類型不匹配、以及 RefundHandler 路由未註冊導致前端瘋狂輪詢的嚴重問題。

---

## 問題與修復

### 1. Docker 服務啟動問題

**現象:** 執行 `docker compose watch` 後，服務停在 `Created` 狀態沒有啟動。

**原因:** AutoMigrate 失敗導致服務退出。

**解決:**
- 手動執行 `docker compose up backend-go -d --build`
- 查看 logs 找出根本原因

---

### 2. AutoMigrate 外鍵約束錯誤

**錯誤:**
```
Error 1832: Cannot change column 'role_id': used in a foreign key constraint 'fk_user_role'
```

**修復:** 在 `docker-compose.yml` 加入環境變數
```yaml
- AUTO_MIGRATE_ENABLED=false
```

**待處理:** 需要手動處理外鍵約束或修改資料庫 schema。

---

### 3. User.LastLogin 類型不匹配

**錯誤:**
```
sql: Scan error on column "last_login": converting time.Time to int64
```

**修復檔案:**
| 檔案 | 修改 |
|------|------|
| `internal/models/user.go` | `LastLogin *int64` → `LastLogin *time.Time` |
| `internal/service/auth_service.go` | `time.Now().UnixMilli()` → `time.Now()` |
| `internal/models/user_test.go` | 更新測試中的類型 |

---

### 4. Role 軟刪除欄位不存在

**錯誤:**
```
Error 1054: Unknown column 'role.deleted_at'
```

**原因:** `Role` 使用 `Base`（包含 `DeletedAt`），但資料庫沒有此欄位。

**修復:**
1. 在 `base.go` 新增 `BaseWithoutSoftDelete` struct
2. 將 `role.go` 改用 `BaseWithoutSoftDelete`

---

### 5. RefundHandler 路由未註冊（最嚴重）

**現象:**
- `/api/v1/refunds/pending-count` 返回 404
- 前端每分鐘輪詢一次
- 累積 1297 個失敗請求
- 頁面載入時間 11 分鐘

**原因:** `RefundHandler` 完全沒有在 `main.go` 註冊！

**修復:**
在 `cmd/server/main.go` 加入：
```go
// Repository
refundRepo := repository.NewRefundRepository(database.DB)

// Service
refundService := service.NewRefundService(refundRepo, orderRepo, paymentService, notificationService)

// Handler
refundHandler := handler.NewRefundHandler(refundService)

// Routes
setupRefundRoutes(v1, refundHandler)
```

新增 8 個路由：
- `GET /api/v1/refunds`
- `GET /api/v1/refunds/pending-count`
- `GET /api/v1/refunds/can-approve`
- `POST /api/v1/refunds/request`
- `GET /api/v1/refunds/order/:order_id/history`
- `GET /api/v1/refunds/:refund_id`
- `POST /api/v1/refunds/:refund_id/approve`
- `POST /api/v1/refunds/:refund_id/reject`

---

## 建立的文件

| 檔案 | 說明 |
|------|------|
| `docs/DOCKER_TROUBLESHOOTING.md` | Docker 開發環境問題排解指南 |
| `Abby-notes/Golang/GORM.md` | GORM 學習筆記（含軟刪除說明）|
| `docs/issues/2026-01-20-backend-go-fixes.md` | GitHub Issue 草稿 |

---

## 修改的檔案總覽

| 檔案 | 修改類型 |
|------|----------|
| `docker-compose.yml` | 加入 `AUTO_MIGRATE_ENABLED=false` |
| `internal/models/user.go` | `LastLogin` 類型修正 + `import "time"` |
| `internal/models/base.go` | 新增 `BaseWithoutSoftDelete` |
| `internal/models/role.go` | 改用 `BaseWithoutSoftDelete` |
| `internal/models/user_test.go` | 更新測試 |
| `internal/service/auth_service.go` | `LastLogin` 賦值修正 |
| `cmd/server/main.go` | 新增 RefundHandler 完整註冊 |

---

## 學到的教訓

1. **新增 Handler 後要記得註冊路由** - 這次 RefundHandler 寫完但沒註冊，導致嚴重問題
2. **Model 類型要與資料庫一致** - `int64` vs `time.Time` 的不匹配會導致 Scan 錯誤
3. **軟刪除不是必須的** - 如果資料庫沒有 `deleted_at`，就用 `BaseWithoutSoftDelete`
4. **docker compose watch 不保證服務啟動** - 出問題時要手動 `up --build` 並查看 logs

---

## 明日待辦

- [ ] 處理 `fk_user_role` 外鍵約束問題（決定是否重新啟用 AutoMigrate）
- [ ] 新增 `/health` 端點修復 healthcheck
- [ ] 確認前端載入速度是否改善
- [ ] 提交 GitHub Issue
