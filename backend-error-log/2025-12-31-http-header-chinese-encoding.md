# HTTP Header ä¸­æ–‡ç·¨ç¢¼å•é¡Œ

**æ—¥æœŸï¼š2025-12-31**

## é‡åˆ°çš„å•é¡Œ

åŒ¯å‡º Excel æ™‚ï¼Œæª”ååŒ…å«ä¸­æ–‡ï¼ˆå¦‚ã€Œå» å•†æ”¯ä»˜_äºæ´²é¦™æ°´ç¯€.xlsxã€ï¼‰ï¼Œçµæœå ±éŒ¯ï¼š

```
UnicodeEncodeError: 'latin-1' codec can't encode characters in position 36-40: ordinal not in range(256)
```

---

## Latin-1 æ˜¯ä»€éº¼ï¼Ÿç‚ºä»€éº¼ä¸æ”¯æ´ä¸­æ–‡ï¼Ÿ

### Latin-1 (ISO-8859-1) ç°¡ä»‹

Latin-1 æ˜¯ä¸€ç¨®**å–®å­—ç¯€ç·¨ç¢¼**ï¼Œåªèƒ½è¡¨ç¤º 256 å€‹å­—å…ƒï¼ˆ0-255ï¼‰ã€‚

| ç¯„åœ | å…§å®¹ |
|------|------|
| 0-127 | ASCIIï¼ˆè‹±æ–‡ã€æ•¸å­—ã€æ¨™é»ï¼‰|
| 128-255 | è¥¿æ­èªè¨€ç‰¹æ®Šå­—å…ƒ |

### Latin-1 æ”¯æ´çš„å­—å…ƒç¯„ä¾‹

```
âœ… æ”¯æ´ï¼šA-Z, a-z, 0-9, !@#$%
âœ… æ”¯æ´ï¼šÃ©, Ã±, Ã¼, ÃŸ, Ã¸, Ã¥ ï¼ˆè¥¿æ­èªè¨€ï¼‰
âœ… æ”¯æ´ï¼šÂ£, â‚¬, Â©, Â® ï¼ˆç¬¦è™Ÿï¼‰

âŒ ä¸æ”¯æ´ï¼šä¸­æ–‡ï¼ˆéœ€è¦ 2-4 bytesï¼‰
âŒ ä¸æ”¯æ´ï¼šæ—¥æ–‡ã€éŸ“æ–‡
âŒ ä¸æ”¯æ´ï¼šä¿„æ–‡ã€å¸Œè‡˜æ–‡
âŒ ä¸æ”¯æ´ï¼šemoji ğŸ˜€
```

### ç‚ºä»€éº¼ HTTP Header ç”¨ Latin-1ï¼Ÿ

HTTP/1.1 è¦ç¯„ï¼ˆRFC 2616ï¼‰è¦å®š Header å€¼åªèƒ½ç”¨ ISO-8859-1ï¼ˆLatin-1ï¼‰ç·¨ç¢¼ã€‚
é€™æ˜¯ 1999 å¹´çš„è¦ç¯„ï¼Œç•¶æ™‚åœ‹éš›åŒ–éœ€æ±‚ä¸é«˜ã€‚

```python
# é€™æœƒçˆ†ç‚¸ï¼Œå› ç‚ºã€Œå» å•†ã€è¶…å‡º Latin-1 ç¯„åœ
headers = {"Content-Disposition": "attachment; filename=å» å•†æ”¯ä»˜.xlsx"}
```

---

## RFC 5987 æ˜¯ä»€éº¼ï¼Ÿ

RFC 5987 æ˜¯ 2010 å¹´ç™¼å¸ƒçš„æ¨™æº–ï¼Œå°ˆé–€è§£æ±º HTTP Header çš„é ASCII å­—å…ƒå•é¡Œã€‚

### æ ¼å¼èªªæ˜

```
filename*=ç·¨ç¢¼æ ¼å¼'èªè¨€æ¨™ç±¤'URLç·¨ç¢¼çš„æª”å
```

| éƒ¨åˆ† | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| `filename*` | è¡¨ç¤ºä½¿ç”¨æ“´å±•æ ¼å¼ï¼ˆæ³¨æ„æ˜Ÿè™Ÿ `*`ï¼‰|  |
| `UTF-8` | ç·¨ç¢¼æ ¼å¼ | UTF-8 |
| `''` | èªè¨€æ¨™ç±¤ï¼ˆå¯é¸ï¼Œé€šå¸¸ç•™ç©ºï¼‰| ç©º |
| `URLç·¨ç¢¼` | æŠŠä¸­æ–‡è½‰æˆ %XX æ ¼å¼ | %E5%BB%A0%E5%95%86 |

### å¯¦éš›ç¯„ä¾‹

```python
from urllib.parse import quote

filename = "å» å•†æ”¯ä»˜_äºæ´²é¦™æ°´ç¯€.xlsx"
encoded = quote(filename, safe="")
# encoded = "%E5%BB%A0%E5%95%86%E6%94%AF%E4%BB%98_%E4%BA%9E%E6%B4%B2%E9%A6%99%E6%B0%B4%E7%AF%80.xlsx"

# æœ€çµ‚ Header
headers = {
    "Content-Disposition": f"attachment; filename*=UTF-8''{encoded}"
}
```

### URL ç·¨ç¢¼å°ç…§è¡¨

| ä¸­æ–‡ | UTF-8 Bytes | URL ç·¨ç¢¼ |
|------|-------------|----------|
| å»  | E5 BB A0 | %E5%BB%A0 |
| å•† | E5 95 86 | %E5%95%86 |
| æ”¯ | E6 94 AF | %E6%94%AF |
| ä»˜ | E4 BB 98 | %E4%BB%98 |

---

## UTF-8 å’Œ RFC 5987 å¦‚ä½•æ­é…ï¼Ÿ

```
1. ä¸­æ–‡ "å» å•†"
      â†“
2. UTF-8 ç·¨ç¢¼ï¼šE5 BB A0 E5 95 86ï¼ˆ6 bytesï¼‰
      â†“
3. URL ç·¨ç¢¼ï¼š%E5%BB%A0%E5%95%86ï¼ˆç´” ASCIIï¼‰
      â†“
4. æ”¾å…¥ Headerï¼šfilename*=UTF-8''%E5%BB%A0%E5%95%86
      â†“
5. ç€è¦½å™¨æ”¶åˆ°å¾Œï¼ŒçŸ¥é“æ˜¯ UTF-8 ç·¨ç¢¼ï¼Œè‡ªå‹•è§£ç¢¼é‚„åŸ
      â†“
6. ä¸‹è¼‰æ™‚é¡¯ç¤ºï¼šå» å•†
```

### ç‚ºä»€éº¼é€™æ¨£å¯ä»¥ï¼Ÿ

URL ç·¨ç¢¼å¾Œçš„çµæœï¼ˆå¦‚ `%E5%BB%A0`ï¼‰å…¨éƒ¨éƒ½æ˜¯ ASCII å­—å…ƒï¼š
- `%` = 37
- `E` = 69
- `5` = 53
- ...

å…¨éƒ¨éƒ½åœ¨ Latin-1 ç¯„åœå…§ï¼ˆ0-255ï¼‰ï¼Œæ‰€ä»¥ä¸æœƒå ±éŒ¯ï¼

---

## ç¨‹å¼ç¢¼ä¿®æ­£

```python
# ä¿®æ­£å‰ï¼ˆæœƒçˆ†ç‚¸ï¼‰
return StreamingResponse(
    excel_file,
    headers={"Content-Disposition": f"attachment; filename={filename}"},
)

# ä¿®æ­£å¾Œï¼ˆæ­£ç¢ºï¼‰
from urllib.parse import quote

encoded_filename = quote(filename, safe="")
return StreamingResponse(
    excel_file,
    headers={
        "Content-Disposition": f"attachment; filename*=UTF-8''{encoded_filename}"
    },
)
```

---

## ç€è¦½å™¨æ”¯æ´åº¦

| ç€è¦½å™¨ | æ”¯æ´ RFC 5987 |
|--------|---------------|
| Chrome | âœ… æ”¯æ´ |
| Firefox | âœ… æ”¯æ´ |
| Safari | âœ… æ”¯æ´ |
| Edge | âœ… æ”¯æ´ |
| IE 11 | âš ï¸ éƒ¨åˆ†æ”¯æ´ |

ç¾ä»£ç€è¦½å™¨éƒ½å®Œæ•´æ”¯æ´ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚

---

## ç›¸é—œæª”æ¡ˆ
- `backend/app/api/routes/vendor_payment_methods.py`
