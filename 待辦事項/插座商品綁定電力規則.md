# 待辦：插座商品綁定電力計算規則

**建立日期**: 2026-01-03
**頁面**: http://localhost:5003/order-electricity

---

## 問題描述

插座商品遷移到 product 表後，需要確保綁定邏輯正確。

## 關鍵關聯

### 資料表關係

```
electricity_calculation_rule
├── event_id                              # 活動 ID
├── gc_or_electricity_provider_company_id # 電力供應商公司 ID
└── included_product_id                   # 綁定的插座商品 ID
        │
        ▼
    product
    ├── id
    ├── event_id                          # 可為 NULL（全域商品）
    └── provider_company_id               # 供應商公司 ID
```

### 綁定規則

1. **活動篩選**
   - electricity_calculation_rule 依 `event_id` 篩選
   - 插座商品可能是全域（event_id = NULL）或特定活動

2. **供應商一致性**
   - `product.provider_company_id` 必須等於 `electricity_calculation_rule.gc_or_electricity_provider_company_id`
   - 確保插座商品屬於同一個電力供應商

## 待實作項目

### 後台 order-electricity 頁面

- [ ] 篩選插座商品時，需依據當前選擇的活動和供應商過濾
- [ ] 只顯示 `provider_company_id` 與 `gc_or_electricity_provider_company_id` 相符的插座商品
- [ ] 選擇電力規則時，動態載入該供應商的可用插座商品

### API 調整

- [ ] `/api/v1/products/all` 可能需要新增參數：
  - `provider_company_id`: 供應商公司 ID
  - `event_id`: 活動 ID（包含 NULL 的全域商品）

### 前端邏輯

```typescript
// 範例：篩選插座商品
const filteredOutlets = products.filter(p =>
  p.provider_company_id === selectedRule.gc_or_electricity_provider_company_id &&
  (p.event_id === null || p.event_id === selectedEventId)
);
```

---

## 相關檔案

- `frontend/src/routes/_layout/order-electricity.tsx`
- `backend/app/api/routes/products.py`
- `backend/app/models/general_contractor.py` (ElectricityCalculationRule)
- `backend/app/models/product.py`

## 備註

- 目前插座商品是全域的（event_id = NULL）
- 可能需要考慮是否要讓插座商品也綁定到特定活動
