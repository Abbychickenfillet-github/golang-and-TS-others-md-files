# 網路基礎概念筆記

## 1. 內部埠 vs 外部埠 (Internal vs External Ports)

這兩個概念主要出現在網路位址轉換 (NAT) 的情境下，例如家用或公司網路透過路由器連網。

### 定義
*   **內部埠 (Internal Port)**：
    *   這是**區域網路 (LAN)** 內，您的設備（電腦/伺服器）實際執行服務並監聽的埠號。
    *   例如：您的 Web 伺服器軟體（如 Apache/Nginx）設定在 Port **80** 執行。

*   **外部埠 (External Port)**：
    *   這是**外部網路 (WAN/Public IP)** 嘗試連線進來時使用的埠號。
    *   通常設定在**路由器 (Router)** 或 **Gateway** 上。

### 運作原理 (Port Forwarding)
當設定「外部 8080 轉發給內部 80」時：
1.  外部使用者連線 `公網IP:8080`。
2.  **路由器**收到請求（路由器監聽 8080）。
3.  路由器根據規則，將請求轉送給內網電腦的 **80** 埠。

> **重要觀念**：
> 對您的電腦而言，它只知道自己在 Port 80 運作。所謂的 "8080" 是路由器的對外窗口，不是您的電腦直接開啟的（除非是在本機使用 Docker 的 Port Mapping 情境）。

---

## 2. API Gateway (API 閘道器)

### 什麼是 API Gateway？
API Gateway 是系統架構中的**單一入口點**，扮演類似「總機櫃檯」或「餐廳接待員」的角色。它介於客戶端 (Client) 和後端微服務 (Microservices) 之間。

### 為什麼需要它？
如果沒有 Gateway，前端 (App/Web) 需要直接知道每個後端服務的 IP 和 Port (如訂單服務、用戶服務、金流服務...)。這樣不安全且難以管理。

### 核心功能
1.  **路由 (Routing)**：
    *   將請求導向正確的後端服務。
    *   Client 呼叫 `/orders` -> 轉送給訂單服務 (`192.168.1.50:8001`)。
    *   Client 呼叫 `/users` -> 轉送給用戶服務 (`192.168.1.51:4000`)。
2.  **安全性 (Security)**：
    *   統一處理身分驗證 (Authentication)，擋掉無效的請求，保護內部服務。
3.  **負載平衡 (Load Balancing)**：
    *   如果後端有多台機器，Gateway 可以分配流量。
4.  **流量限制 (Rate Limiting)**：
    *   限制請求頻率，防止被惡意攻擊或流量過大打掛服務。
5.  **日誌與監控 (Logging)**：
    *   統一記錄所有進出的請求。

### 架構圖解

```mermaid
graph LR
    Client((使用者))
    Gateway[API Gateway<br/>(總機櫃檯)]
    ServiceA[訂單服務]
    ServiceB[用戶服務]
    ServiceC[金流服務]

    Client -->|統一請求入口| Gateway
    Gateway -->|轉發| ServiceA
    Gateway -->|轉發| ServiceB
    Gateway -->|轉發| ServiceC

    style Gateway fill:#ff9,stroke:#333,stroke-width:2px
```

### 常見工具
*   **Nginx** (常用且強大)
*   AWS API Gateway
*   Kong

---

## 3. 常見 IP 類型比較 (Localhost, LAN, Docker/WSL)

這三者都代表「網路地址」，但適用範圍與情境不同。

### 1. Localhost (127.0.0.1)
*   **意義**：「我」、「本機」、「我自己」。
*   **範圍**：只有**這台電腦自己**看得到。
*   **情境**：開發測試時最常用，速度最快，不經過網卡。

### 2. LAN IP (例如 192.168.1.50)
*   **意義**：「我在這裡 (辦公室/家裡) 的門牌號碼」。
*   **範圍**：同一區域網路 (Wi-Fi/Switch) 內的設備都看得到。
*   **情境**：讓同事連線測試、手機連電腦測試、正式部署的內部服務 IP。

### 3. Docker/WSL IP (例如 172.18.16.1)
*   **意義**：「電腦內部的虛擬網路」。
*   **範圍**：通常只有**Host 電腦**與**容器(Container)** 之間看得到，外部無法直接連線。
*   **情境**：
    *   **Docker**：Container 之間的溝通，或 Host 連線到 Container。
    *   **WSL 2**：Windows 與 Linux 子系統之間的溝通橋樑。
    *   當您看到 `172.x.x.x` 開頭的 IP，通常就是這類虛擬 IP。

### 總結比較表

| 特性 | localhost (127.0.0.1) | LAN IP (192.168.x.x) | Docker/WSL IP (172.x.x.x) |
| :--- | :--- | :--- | :--- |
| **誰能連？** | 只有自己 | 同一網路內的其他人 + 自己 | Host 電腦 + 容器 (Container) |
| **用途** | 本機開發、測試 | 區域網路分享、正式部署 | 容器化應用、虛擬機溝通 |
| **譬喻** | 「我心裡想的事」 | 「我在辦公室大喊」 | 「透過對講機跟房間裡的人說話」 |

### 常見問答：我的同事看得到我的 Docker IP 嗎？

**Q：如果我的 Docker 跑在 `172.18.16.1`，我隔壁的同事（也在同一個內網）能直接連到這個 IP 嗎？**

**A：不能。** (幾乎皆為不能)

因為 `172.x.x.x` 是您電腦「內部」的虛擬網路。
*   **同事的電腦**：他不知道 `172.18.16.1` 誰。他的電腦可能會以為這是他自己內部的 Docker，或者根本找不到路。
*   **如何讓同事連到？**
    您必須使用 **Port Forwarding (端口轉發)**。
    例如：在啟動 Docker 時設定 `-p 8080:80`。
    這樣同事連線您的 **LAN IP** (`192.168.1.50:8080`)，您的電腦就會幫忙把訊號轉進去給 Docker。
    *   同事 --> (連線) --> 您電腦 IP (`192.168.1.50`) --> (轉發) --> Docker IP (`172.18.16.1`)

---

## 4. 觀念統整：誰是 Gateway？(層狀結構)

「內部」和「外部」是相對的。Port Forwarding 的概念在不同層級都一樣，只是角色換了人當。

### 情境 A：以及您提到的「路由器」例子
*   **Gateway 角色**：**路由器 (Router)**
*   **外部 (External)**：公網 (Internet) --> 連線到路由器的 `8080`
*   **內部 (Internal)**：您的電腦 (LAN) --> 路由器轉發給電腦的 `80`
*   **結論**：是的，在這個例子中，8080 在路由器上，80 在您的電腦上。

### 情境 B：Docker 的例子
當您在 Docker 設定 `-p 8080:80` 時：
*   **Gateway 角色**：**您的電腦 (Your Computer)**
*   **外部 (External)**：辦公室網路 (LAN) --> 同事連線到您電腦的 `8080`
*   **內部 (Internal)**：Docker 容器 (Container) --> 電腦轉發給容器的 `80`
*   **結論**：在這個例子中，**8080 在您的電腦上**，80 在容器裡。

> **一句話總結**：
> **Port Forwarding (端口轉發) 就是「大門守衛」把信轉交給「內部房客」的過程。**
> *   對家裡電腦來說，路由器是守衛。
> *   對 Docker 來說，您的電腦是守衛。
